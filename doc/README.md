# SocksFusion

SocksFusion - утилита для проброса TCP-сообщений по шифрованному туннелю сквозь сетевой экран, выглядящее для клиентских приложений как сервер Socks5. Состоит из двух компонентов: **Proxy**, устанавливаемый на нашей стороне и обеспечивающий идентификацию агентов, и **Agent**, распространяемое приложение, устанавливающее соединение с Proxy.

Приблизительная схема сетевых соединений:

                                             +--------+
                                             | Rabbit |
                                             +--------+
                                                 ^
                                     NAT         |
    +--------+         +-------+     | |     +-------+         +--------+
    | Target | <------ | Agent | ----|-|---> | Proxy | <------ | Client |
    +--------+         +-------+     | |     +-------+         +--------+


## Agent

Agent устанавливает соединение с Proxy по указанному адресу и пытается идентифицироваться по указанному ключу. Если попытка успешна, то пытается отвечать на проброшенные клиентские пакеты и открывать соединения с целью, запрошенной в соответствии с протоколом Socks5.

### Отладочные сообщения

В течение работы Агент может писать следующие сообщения в stdout:
    * `New session` - пытаемся соединиться с Proxy.
    * `Wrong key` - ключ агента не зарегистрирован в системе, возможно, скорее всего была сделана ещё одна верификация. Агент будет пытаться переподключиться с тем же ключом каждые две секунды.
    * `Another agent already connected` - с данным ключом уже работает другой агент. Агент будет пытаться переподключиться с тем же ключом каждые две секунды.
    * `Established` - Агент прошёл проверку, соединение с Proxy успешно установлено.
    * `Silence [<host>:<port>]` - не удаётся связаться с указанным адресом. Возможно, Proxy не запущен или что-то блокирует соединение. Если host - сканируемая цель, то агент не может с ней соединиться.

## Proxy

Использование: `Proxy2 <rabbit_address> <rabbit_creds> <agent_port> <controller_port>`

Служит сервером для приходящих соединений от агентов и клиентов (инстансов сканеров), частично управляется контроллерами webengine. После запуска слушает два указанных порта, на первый принимает соединения от агентов, устанавливает защищённое TLS соединение и в течение всего сканирования пробрасывает по нему сообщения от клиентов. Второй порт служит для общения с контроллерами и изменению списка допустимых ключей агентов.

### Отладочные сообщения

В течение работы Прокси может писать следующие сообщения в stdout:
    * `<key> already running` - попытка подключения Агента с указанным ключом отклонена, поскольку уже подключён другой агент с тем же ключом.
    * `<key> established` - Агент прошёл проверку, соединение установлено.
    * `Listen :^: (IPv6(+4?),<port>)` - Прокси слушает данный порт, если он отличается от <agent_port>, <controller_port>, значит это один из портов, ожидающий клиентских сообщений.

## Имитация контроллера

Сразу после запуска Прокси будет иметь пустую таблицу допустимых ключей. Добавить туда ключ можно при помощи фейкового контроллера. Все сообщения между Прокси и контроллером упаковываются:
 
    +-----+----------+
    | LEN |    MSG   |
    +-----+----------+
    |  4  | Variable |
    +-----+----------+

    where:
        LEN    little-endian int 32
        MSG    bytestring with given length

После подключения контроллер может посылать сообщения вида `+<key>`, `-<key>` и `*<key>` чтобы добавить, удалить ключ из списка допустимых или сообщить что скоро будет сканирование по этому ключу. Если контроллер добавил ключ и уведомил о грядущем сканировании, а на прокси пришёл агент с таким ключом, то контроллер получит сообщение `<key>:<port>`, на указанный порт теперь могут использовать клиенты в качестве порта Socks сервера. Если контроллер получил `Wrong message` - предыдущее сообщение было в неверном формате.
